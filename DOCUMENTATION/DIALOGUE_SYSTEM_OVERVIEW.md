# Dialogue System Overview

This document outlines the key components, flow, and mechanisms involved in the LLM-powered dialogue system.

## 1. Key Components

### Scripts

*   **`DialogueControl.cs` (`Assets/Scripts/NPCs/`)**:
    *   Attached to the main Dialogue UI Canvas/GameObject.
    *   Manages the activation and deactivation of the dialogue UI (including animations).
    *   Handles game state transitions (`GameState.DIALOGUE` <-> `GameState.DEFAULT`).
    *   Acts as the entry point when player interacts with an NPC.
    *   Calls `LLMCharacter.Load()` on activation (if save exists) and `LLMCharacter.Save()` on deactivation.
    *   Calls `LLMDialogueManager.InitializeDialogue()` and `ResetDialogue()`.
    *   Provides methods (`DisplayNPCDialogueStreaming`) for updating the UI text, potentially integrating with `BeepSpeak.cs`.
    *   Handles Escape key input to deactivate dialogue.
    *   Calls `LLMCharacter.CancelRequests()` indirectly via `ResetDialogue` when deactivated.

*   **`BaseDialogueManager.cs` (`Assets/Scripts/Dialogue/`)**:
    *   Abstract base class providing core dialogue logic.
    *   Holds reference to the current `LLMCharacter`.
    *   Manages response processing state (`isProcessingResponse`).
    *   Receives LLM responses via the `HandleReply` callback.
    *   **Parses Function Calls:** Checks for `\nACTION:` delimiter in `HandleReply`. If found, splits dialogue from action string and calls `ProcessFunctionCall`.
    *   **Handles Function Calls (`ProcessFunctionCall`):**
        *   `stop_conversation`: Calls `DialogueControl.Deactivate()`.
        *   `reveal_node`: Extracts `node_id` parameter using `ExtractNodeId` and calls `GameControl.coreConstellation.DiscoverNode(nodeId)`.
    *   Handles cancellation via `ResetDialogue` which calls `LLMCharacter.CancelRequests()`.
    *   Defines abstract methods for UI interaction (`EnableInput`, `DisableInput`, `UpdateDialogueDisplay`).

*   **`LLMDialogueManager.cs` (`Assets/Scripts/Dialogue/`)**:
    *   Concrete implementation inheriting from `BaseDialogueManager`.
    *   Likely attached to the same GameObject as `DialogueControl` or a child object within the Dialogue Canvas prefab.
    *   Holds references to specific UI elements (`TMP_InputField`, `TMP_Text` for player/NPC dialogue, `Button`).
    *   Handles player input submission (`OnSubmitClicked`) and sends it to `LLMCharacter.Chat()`.
    *   Implements `UpdateDialogueDisplay` to forward text to `DialogueControl` (for BeepSpeak/UI).
    *   Implements `EnableInput`/`DisableInput` to manage UI interactability.
    *   Registers itself with `DialogueControl`.

*   **`CharacterPromptGenerator.cs` (`Assets/Scripts/Characters/`)**:
    *   Static class responsible for creating the detailed system prompt string passed to the `LLMCharacter`.
    *   Uses data from `MysteryCharacter` and the overall `MysteryMetadata` (context, title).
    *   Includes specific instructions for the LLM on how to format function calls (`\nACTION: ...`) and when to trigger revelations based on player input or evidence presentation.

*   **`LLMCharacter.cs` (LLMUnity Package)**:
    *   The core component interfacing with the actual LLM backend.
    *   Receives the system prompt generated by `CharacterPromptGenerator`.
    *   Handles the `Chat()` requests, sending input + history + prompt to the LLM.
    *   Provides the streaming response via the `HandleReply` callback.
    *   Provides `Load()` and `Save()` methods for conversation history/cache.
    *   Provides `CancelRequests()` to attempt stopping ongoing generation.

*   **`MysteryConstellation.cs` (`Assets/Scripts/CoreControl/MysteryParsing/Constellation/`)**:
    *   Contains the `DiscoverNode(string nodeKey)` method, which is the target for the `reveal_node` function call. It handles the logic for unlocking nodes in the game's mystery graph.

*   **`BeepSpeak.cs` (`Assets/DialogueSFX/`)**:
    *   Optional component referenced by `DialogueControl`.
    *   Used to display dialogue text with a typing effect and associated audio feedback. `DialogueControl.DisplayNPCDialogueStreaming` updates its text.

### Scene Objects / Prefabs

*   **Dialogue Canvas GameObject**: The main UI canvas holding all dialogue elements. Activated/deactivated by `DialogueControl`. Contains the `DialogueControl` script and likely the `LLMDialogueManager`.
*   **NPC Dialogue Text (TMP_Text)**: UI element displaying the NPC's response. Managed by `LLMDialogueManager` via `DialogueControl`.
*   **Player Dialogue Text (TMP_Text)**: UI element displaying the player's last input. Managed by `LLMDialogueManager`.
*   **Input Field (TMP_InputField)**: Where the player types their dialogue. Managed by `LLMDialogueManager`.
*   **Submit Button (Button)**: Button to send player input. Managed by `LLMDialogueManager`.
*   **NPC Prefab**: Contains the `Character.cs` component which links the physical NPC to its corresponding `LLMCharacter` instance managed by `CharacterManager`. Player interaction with the NPC likely triggers `DialogueControl.Activate()`.

## 2. Dialogue Flow

1.  **Activation**: Player interacts with an NPC (e.g., presses 'E'). The NPC's interaction logic calls `DialogueControl.Activate(npcGameObject)`.
2.  **Character Setup**: `DialogueControl` gets the `Character` component, retrieves the associated `LLMCharacter` instance, and calls `llmDialogueManager.SetCharacter()`.
3.  **Load History**: `DialogueControl` checks if a save file exists for the character and calls `await llmCharacter.Load()` if it does.
4.  **UI Activation**: `DialogueControl` activates the Dialogue Canvas and plays an activation animation. `GameControl` state is set to `DIALOGUE`.
5.  **Initialization**: Once the animation is complete, `DialogueControl` calls `llmDialogueManager.InitializeDialogue()`, which enables the input field.
6.  **Player Input**: Player types in the `InputField` and clicks `Submit` or presses Enter.
7.  **Send to LLM**: `LLMDialogueManager.OnSubmitClicked` disables input, clears previous response data, and calls `llmCharacter.Chat(userInput, HandleReply, OnReplyComplete)`.
8.  **LLM Response (Streaming)**: `LLMCharacter` sends the request to the LLM. As response chunks arrive, the `HandleReply` callback in `BaseDialogueManager` is invoked.
9.  **Response Parsing (`HandleReply`)**:
    *   Checks for `\nACTION:`.
    *   If found, splits the text into dialogue (`processedReply`) and action (`functionCall`).
    *   Calls `ProcessFunctionCall(functionCall)`.
    *   Appends the dialogue part (`processedReply`) to `currentResponse`.
    *   Calls `UpdateDialogueDisplay(currentResponse.ToString())`.
10. **UI Update (`UpdateDialogueDisplay`)**: `LLMDialogueManager` forwards the accumulating dialogue text to `DialogueControl`, which updates the NPC text UI (potentially via BeepSpeak).
11. **Function Execution (`ProcessFunctionCall`)**: If an action was parsed:
    *   `stop_conversation`: `DialogueControl.Deactivate()` is called.
    *   `reveal_node`: `node_id` is extracted, `GameControl.coreConstellation.DiscoverNode(nodeId)` is called.
12. **Reply Complete (`OnReplyComplete`)**: Called by `LLMCharacter` when the full response is generated. `BaseDialogueManager` sets `isProcessingResponse = false` and re-enables input via `EnableInput()`.
13. **Deactivation (Escape Key)**: Player presses Escape. `DialogueControl.Update()` detects this and calls `Deactivate()`.
14. **Deactivation (Function Call)**: `stop_conversation` function call triggers `DialogueControl.Deactivate()`.
15. **Deactivation Process (`DeactivateDialogue` Coroutine)**:
    *   Calls `llmDialogueManager.ResetDialogue()` which calls `llmCharacter.CancelRequests()`. Waits for this task.
    *   Calls `llmCharacter.Save()` to save conversation history. Waits for this task.
    *   Plays deactivation animation.
    *   Deactivates Dialogue Canvas.
    *   Resets `GameControl` state to `DEFAULT`.

## 3. Function Calling Details

*   **Prompting**: `CharacterPromptGenerator` explicitly tells the LLM the available functions (`reveal_node`, `stop_conversation`), their parameters, and the **exact** output format (`\nACTION: function_name(param=value)` on a new line after dialogue). It also links revelation triggers to the `reveal_node` action.
*   **Parsing**: `BaseDialogueManager.HandleReply` uses `reply.IndexOf("\nACTION: ")` to find the delimiter and `Substring` to split the dialogue from the action string. `ExtractNodeId` uses `IndexOf` again to get the `node_id` parameter value.
*   **Execution**: `BaseDialogueManager.ProcessFunctionCall` uses `StartsWith` to identify the function and then calls the relevant game logic (`DialogueControl.Deactivate` or `MysteryConstellation.DiscoverNode`).

## 4. State Management

*   **Game State**: `GameControl.currentState` is set to `GameState.DIALOGUE` during activation and back to `GameState.DEFAULT` during deactivation. Player movement and other systems likely check this state.
*   **Dialogue UI State**: `DialogueControl` manages the active state of the canvas and UI animations (`isTransitioning`).
*   **LLM Response State**: `BaseDialogueManager.isProcessingResponse` flag prevents sending new requests while waiting for a reply.
*   **Input State**: `LLMDialogueManager` enables/disables the input field and submit button via `EnableInput`/`DisableInput`.

## 5. Dependencies & Interactions

*   `Player Interaction` -> `NPC` -> `DialogueControl.Activate`
*   `DialogueControl` -> `LLMCharacter` (Load, Save)
*   `DialogueControl` -> `LLMDialogueManager` (SetCharacter, InitializeDialogue, ResetDialogue)
*   `LLMDialogueManager` -> `LLMCharacter` (Chat)
*   `LLMCharacter` -> `BaseDialogueManager` (HandleReply, OnReplyComplete callbacks)
*   `BaseDialogueManager` -> `LLMDialogueManager` (UpdateDialogueDisplay, EnableInput, DisableInput - abstract calls)
*   `BaseDialogueManager` -> `DialogueControl` (Deactivate via ProcessFunctionCall)
*   `BaseDialogueManager` -> `MysteryConstellation` (DiscoverNode via ProcessFunctionCall)
*   `LLMDialogueManager` -> `DialogueControl` (DisplayNPCDialogueStreaming)
*   `DialogueControl` -> `BeepSpeak` (Optional: StartDialogue, UpdateStreamingText)

This covers the core aspects of the dialogue system as implemented and discussed.
